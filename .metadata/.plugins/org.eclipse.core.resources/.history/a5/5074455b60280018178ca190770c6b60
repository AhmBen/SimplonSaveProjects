package constrainteEtTransactions;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Random;

public class VentesAuPif {
	public static void main(String[] args) {
		//Connection conn = SqlQuery.getConnection();
		Random rng= new Random();
		
		int i = 0;
		while(i < 1) {
			 VentesAuPif.unCredit( 1, rng.nextInt(100)+1);
			 VentesAuPif.addToInventory( 1, rng.nextInt(10)+1);
			 VentesAuPif.sell( 1, 1, rng.nextInt(10)+1);
			 i++;
		    }	
	}
	
	public static void unCredit(int clientId,int cash) {
		Connection conn = SqlQuery.getConnection();
		PreparedStatement statement;
		try {
			statement = conn.prepareStatement("UPDATE customer SET credit = credit - ? WHERE pk_id = ?");
			statement.setInt(1, cash);
			statement.setInt(2, clientId);
			statement.executeUpdate();
			statement = conn.prepareStatement("UPDATE cash SET amount = amount - ? WHERE pk_id = 1");
			statement.setInt(1, cash);			
			statement.executeUpdate();
		} catch (SQLException e) {			
			e.printStackTrace();
		}
		
	}
	
	public static void addToInventory(int productId,int qty) {
		Connection conn = SqlQuery.getConnection();
		PreparedStatement statement;
		try {
			statement = conn.prepareStatement("UPDATE product SET qty = qty - ? WHERE pk_id = ?");
			statement.setInt(1, qty);
			statement.setInt(2, productId);
			statement.executeUpdate();
		} catch (SQLException e) {			
			e.printStackTrace();
		}
	}
	
	public static void sell(int clientId,int productId,int qty) {
		Connection conn = SqlQuery.getConnection();
		PreparedStatement statement;
		try {
			statement = conn.prepareStatement("SELECT * FROM PRODUCT WHERE pk_id = ?");
			statement.setInt(1, productId);
			ResultSet res = statement.executeQuery();
			while(res.next()) {
				double prix = res.getDouble("price");				
				statement = conn.prepareStatement("UPDATE sales_log SET qty = qty + ? WHERE fk_product_id = ?");
				statement.setInt(1, qty);
				statement.setInt(2, productId);
				statement.executeUpdate();
				statement = conn.prepareStatement("UPDATE cash SET amount = amount - (? * ?) WHERE pk_id = ?");
				statement.setInt(1, qty);
				statement.setDouble(1, prix);
				statement.setInt(3, productId);
				statement.executeUpdate();
				break;
			}		
			
		} catch (SQLException e) {			
			e.printStackTrace();
		}
		
	}
}
